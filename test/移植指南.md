# æµ‹è¯•ç¨‹åºç§»æ¤æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æµ‹è¯•å¥—ä»¶åŒ…å«ä¸¤ä¸ªç‹¬ç«‹çš„æµ‹è¯•ç¨‹åºï¼Œå·²ç»è¿‡ä¼˜åŒ–ä»¥æœ€å°åŒ–ç¬¬ä¸‰æ–¹åº“ä¾èµ–ï¼Œæ–¹ä¾¿ç§»æ¤åˆ°åµŒå…¥å¼å¼€å‘æ¿ã€‚

## ğŸ”§ ä¾èµ–é¡¹

### å¿…éœ€çš„æ ‡å‡†Cåº“
- `stdio.h` - æ–‡ä»¶IOå’Œprintf
- `stdlib.h` - å†…å­˜åˆ†é…ï¼ˆmalloc/freeï¼‰
- `string.h` - å­—ç¬¦ä¸²æ“ä½œï¼ˆmemsetï¼‰

### å¯é€‰ä¾èµ–ï¼ˆå·²æä¾›æ›¿ä»£æ–¹æ¡ˆï¼‰
- æ—¶é—´å‡½æ•° - æä¾›äº†å¤šå¹³å°é€‚é…
- æ•°å­¦å‡½æ•° - æä¾›äº†ç®€å•å®ç°
- æ–‡ä»¶ç³»ç»Ÿ - ä»…éœ€æ”¯æŒåŸºæœ¬çš„fopen/fread/fwrite

---

## ğŸ”Œ æµ‹è¯•æ¥å£è¯´æ˜

### å¤´æ–‡ä»¶ï¼štest_interface.h

æä¾›å¯è¢«å¤–éƒ¨ç¨‹åºè°ƒç”¨çš„æ¥å£å‡½æ•°ï¼š

```c
/**
 * è¿è¡ŒDGEMMæ€§èƒ½æµ‹è¯•
 * 
 * åŠŸèƒ½ï¼šæµ‹è¯•æ‰€æœ‰DGEMMå®ç°åœ¨ä¸åŒçŸ©é˜µè§„æ¨¡å’Œæ•°å€¼èŒƒå›´ä¸‹çš„æ€§èƒ½
 * æµ‹è¯•é…ç½®ï¼š
 *   - 4ä¸ªæ•°å€¼èŒƒå›´ï¼š[0,1], [1,1e3], [1e3,1e5], [1e5,1e7]
 *   - 2ä¸ªDGEMMå®ç°ï¼šdgemm_unroll, dgemm_unroll_ass
 *   - 9ä¸ªçŸ©é˜µè§„æ¨¡ï¼šä»16x16åˆ°256x256
 *   - æ¯ä¸ªæµ‹è¯•500æ¬¡è¿è¡Œ
 * 
 * è¾“å‡ºï¼šç»“æœç›´æ¥é€šè¿‡printfè¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆ4ä¸ªæ€§èƒ½æ±‡æ€»è¡¨ï¼‰
 * 
 * è¿”å›å€¼ï¼š
 *   0  - æµ‹è¯•æˆåŠŸ
 *   -1 - æµ‹è¯•å¤±è´¥
 */
int run_dgemm_benchmark(void);
```

### ä½¿ç”¨ç¤ºä¾‹

```c
#include <stdio.h>
#include "test_interface.h"

int main(void) {
    printf("å¼€å§‹DGEMMæ€§èƒ½æµ‹è¯•...\n\n");
    
    // è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼ˆåŒ…å«4ä¸ªæ•°å€¼èŒƒå›´ï¼Œå…±72ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    if (run_dgemm_benchmark() != 0) {
        fprintf(stderr, "æ€§èƒ½æµ‹è¯•å¤±è´¥\n");
        return -1;
    }
    
    printf("\næµ‹è¯•å®Œæˆï¼\n");
    return 0;
}
```

### ç¼–è¯‘è¯´æ˜

**ç‹¬ç«‹è¿è¡Œæ¨¡å¼**ï¼ˆåŒ…å«mainå‡½æ•°ï¼‰ï¼š
```bash
# 1. ç¼–è¯‘DGEMMå®ç°ï¼ˆç»Ÿä¸€ä½¿ç”¨-O2ï¼‰
gcc -O2 -I. -c src/dgemm_unroll.c -o dgemm_unroll.o
gcc -O2 -I. -c opt/dgemm_unroll_ass.c -o dgemm_unroll_ass.o

# 2. ç¼–è¯‘åŒ…è£…å‡½æ•°
gcc -O2 -I. -c dgemm_wrappers.c -o dgemm_wrappers.o

# 3. ç¼–è¯‘å¹¶é“¾æ¥æ€§èƒ½æµ‹è¯•ç¨‹åº
gcc -O2 benchmark.c dgemm_unroll.o dgemm_unroll_ass.o dgemm_wrappers.o -o benchmark
```

**åº“æ¨¡å¼**ï¼ˆä¸å«mainå‡½æ•°ï¼Œå¯è¢«å…¶ä»–ç¨‹åºè°ƒç”¨ï¼‰ï¼š
```bash
# 1. ç¼–è¯‘DGEMMå®ç°
gcc -O2 -I. -c src/dgemm_unroll.c -o dgemm_unroll.o
gcc -O2 -I. -c opt/dgemm_unroll_ass.c -o dgemm_unroll_ass.o
gcc -O2 -I. -c dgemm_wrappers.c -o dgemm_wrappers.o

# 2. ç¼–è¯‘æµ‹è¯•ç¨‹åºï¼ˆä¸å«mainå‡½æ•°ï¼‰
gcc -O2 -DNO_MAIN -c benchmark.c -o benchmark.o

# 3. é“¾æ¥åˆ°ä½ çš„ç¨‹åº
gcc -O2 your_program.c benchmark.o dgemm_unroll.o dgemm_unroll_ass.o dgemm_wrappers.o -o your_program
```

---

## ğŸ“Š æµ‹è¯•ç¨‹åºè¯´æ˜

### æ€§èƒ½æµ‹è¯• (benchmark.c)

**åŠŸèƒ½**: æµ‹è¯•çŸ©é˜µä¹˜æ³•çš„è¿è¡Œé€Ÿåº¦

**æ ¸å¿ƒæ¥å£**:
```c
// ========== éœ€è¦ç§»æ¤çš„æ—¶é—´å‡½æ•° ==========
static double get_time_ms(void);
```

**æ—¶é—´å‡½æ•°ç§»æ¤è¯´æ˜**:

å½“å‰ä»£ç æä¾›äº†ä¸‰ç§å¹³å°çš„å®ç°ï¼š

```c
#ifdef _WIN32
    /* Windowså¹³å° - ä½¿ç”¨QueryPerformanceCounter */
    static double get_time_ms(void) {
        LARGE_INTEGER frequency, counter;
        QueryPerformanceFrequency(&frequency);
        QueryPerformanceCounter(&counter);
        return (double)counter.QuadPart * 1000.0 / (double)frequency.QuadPart;
    }

#elif defined(__linux__) || defined(__unix__)
    /* Linux/Unixå¹³å° - ä½¿ç”¨clock_gettime */
    static double get_time_ms(void) {
        struct timespec ts;
        clock_gettime(CLOCK_MONOTONIC, &ts);
        return (double)ts.tv_sec * 1000.0 + (double)ts.tv_nsec / 1000000.0;
    }

#else
    /* å…¶ä»–å¹³å° - ä½¿ç”¨æ ‡å‡†Cçš„clock()å‡½æ•°ï¼ˆç²¾åº¦è¾ƒä½ï¼‰ */
    static double get_time_ms(void) {
        return (double)clock() * 1000.0 / CLOCKS_PER_SEC;
    }
#endif
```

**å¦‚ä½•æ›¿æ¢ä¸ºå¼€å‘æ¿çš„æ—¶é—´å‡½æ•°**:

1. æ‰¾åˆ°å¼€å‘æ¿çš„é«˜ç²¾åº¦è®¡æ—¶å™¨APIï¼ˆå¦‚ç¡¬ä»¶è®¡æ—¶å™¨ã€ç³»ç»Ÿtickç­‰ï¼‰
2. æ›¿æ¢ `get_time_ms()` å‡½æ•°
3. ç¡®ä¿è¿”å›å€¼ä¸º**æ¯«ç§’**å•ä½çš„doubleç±»å‹

**ç¤ºä¾‹ - FT2000Qå¼€å‘æ¿**:
```c
/* FT2000Qå¹³å°ç¤ºä¾‹ */
#include <sys/time.h>
static double get_time_ms(void) {
    struct timeval tv;
    gettimeofday(&tv, NULL);
    return tv.tv_sec * 1000.0 + tv.tv_usec / 1000.0;
}
```

**ç¤ºä¾‹ - è£¸æœº/RTOS**:
```c
/* è£¸æœºæˆ–RTOSå¹³å°ç¤ºä¾‹ */
extern unsigned long get_system_ticks(void);  // å‡è®¾æœ‰è¿™ä¸ªå‡½æ•°
extern unsigned long get_ticks_per_second(void);

static double get_time_ms(void) {
    unsigned long ticks = get_system_ticks();
    unsigned long freq = get_ticks_per_second();
    return (double)ticks * 1000.0 / (double)freq;
}
```

**è¾“å‡º**: 
- ç»ˆç«¯: å®æ—¶è¿›åº¦æ˜¾ç¤º
- æ–‡ä»¶: `benchmark_results.csv`

**æµ‹è¯•é…ç½®**:
- 4ä¸ªæ•°å€¼èŒƒå›´ï¼š
  - Range_0_1: [0, 1]
  - Range_1_1e3: [1, 1000]
  - Range_1e3_1e5: [1000, 100000]
  - Range_1e5_1e7: [100000, 10000000]
- 2ä¸ªDGEMMå®ç°
- 9ä¸ªçŸ©é˜µè§„æ¨¡ï¼ˆ16Ã—16 åˆ° 256Ã—256ï¼‰
- æ¯ä¸ªæµ‹è¯•è¿è¡Œ500æ¬¡
- æ€»æµ‹è¯•æ•°ï¼š72ä¸ªï¼ˆ4èŒƒå›´ Ã— 2å®ç° Ã— 9è§„æ¨¡ï¼‰

**è¿è¡Œ**:
```bash
./benchmark
```

**è¾“å‡º**: 
- å®æ—¶è¿›åº¦æ˜¾ç¤º
- 4ä¸ªæ€§èƒ½æ±‡æ€»è¡¨ï¼ˆæ¯ä¸ªæ•°å€¼èŒƒå›´ä¸€ä¸ªï¼‰
- å¹³å‡æ—¶é—´ç²¾åº¦ï¼š8ä½å°æ•°ï¼ˆæ¯«ç§’ï¼‰

---

## ğŸš€ ç§»æ¤æ­¥éª¤

### Step 1: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ

ç¡®ä¿å¼€å‘æ¿æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
- [ ] Cç¼–è¯‘å™¨ï¼ˆå¦‚gccã€arm-linux-gccç­‰ï¼‰
- [ ] æ ‡å‡†Cåº“ï¼ˆlibcï¼‰
- [ ] æ–‡ä»¶ç³»ç»Ÿï¼ˆç”¨äºè¯»å†™CSVæ–‡ä»¶ï¼‰

### Step 2: ä¿®æ”¹æ—¶é—´å‡½æ•°

åœ¨ `benchmark.c` ä¸­æ‰¾åˆ° `get_time_ms()` å‡½æ•°å¹¶æ›¿æ¢ä¸ºå¼€å‘æ¿çš„å®ç°ã€‚

### Step 3: ç¼–è¯‘

```bash
# ä¿®æ”¹Makefileä¸­çš„ç¼–è¯‘å™¨
CC = arm-linux-gcc  # æˆ–ä½ çš„äº¤å‰ç¼–è¯‘å™¨

# ç¼–è¯‘
make clean
make all
```

### Step 4: è¿è¡Œæµ‹è¯•

æœ‰**ä¸¤ç§ä½¿ç”¨æ–¹å¼**ï¼š

#### æ–¹å¼1ï¼šç‹¬ç«‹è¿è¡Œæµ‹è¯•ç¨‹åº

```bash
# æ€§èƒ½æµ‹è¯•ï¼ˆåŒ…å«4ä¸ªæ•°å€¼èŒƒå›´ï¼Œå…±72ä¸ªæµ‹è¯•ï¼‰
./benchmark
```

#### æ–¹å¼2ï¼šé›†æˆåˆ°å¤§å‹ç¨‹åºä¸­

**ç¼–è¯‘é›†æˆç¨‹åº**ï¼š
```bash
make integrated
```

**åœ¨ä½ çš„ç¨‹åºä¸­è°ƒç”¨æµ‹è¯•æ¥å£**ï¼š
```c
#include "test_interface.h"

int main(void) {
    // ä½ çš„ç¨‹åºé€»è¾‘
    // ...
    
    // è°ƒç”¨æ€§èƒ½æµ‹è¯•ï¼ˆä¼šè¿è¡Œ72ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰
    run_dgemm_benchmark();
    
    // ç»§ç»­ä½ çš„ç¨‹åºé€»è¾‘
    // ...
    
    return 0;
}
```

**ç¼–è¯‘ä½ çš„ç¨‹åº**ï¼š
```bash
# å°†æµ‹è¯•ä»£ç ç¼–è¯‘ä¸ºå¯¹è±¡æ–‡ä»¶ï¼ˆç»Ÿä¸€ä½¿ç”¨-O2ï¼Œä¸å«mainå‡½æ•°ï¼‰
gcc -O2 -I. -c src/dgemm_unroll.c -o dgemm_unroll.o
gcc -O2 -I. -c opt/dgemm_unroll_ass.c -o dgemm_unroll_ass.o
gcc -O2 -I. -c dgemm_wrappers.c -o dgemm_wrappers.o
gcc -O2 -DNO_MAIN -c benchmark.c -o benchmark.o

# é“¾æ¥åˆ°ä½ çš„ä¸»ç¨‹åº
gcc -O2 your_main.c benchmark.o dgemm_wrappers.o \
    dgemm_unroll.o dgemm_unroll_ass.o -o your_program
```

å‚è€ƒç¤ºä¾‹ï¼š`test_main.c`

---

## ğŸ“ æµ‹è¯•é…ç½®

### æ€§èƒ½æµ‹è¯•é…ç½®

å¯åœ¨ `benchmark.c` ä¸­ä¿®æ”¹ï¼š

```c
#define NUM_RUNS 500           // æ¯ä¸ªæµ‹è¯•è¿è¡Œæ¬¡æ•°ï¼ˆå¯å‡å°‘ä»¥åŠ å¿«æµ‹è¯•ï¼‰
#define NUM_VALUE_RANGES 4     // æ•°å€¼èŒƒå›´æ•°é‡ï¼ˆå½“å‰ï¼š0-1, 1-1e3, 1e3-1e5, 1e5-1e7ï¼‰
#define NUM_OPT_FUNCS 2        // ä¼˜åŒ–ç‰ˆæœ¬æ•°é‡
#define NUM_TEST_CASES 9       // çŸ©é˜µè§„æ¨¡æ•°é‡
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘æ—¶æç¤ºæ‰¾ä¸åˆ°clock_gettime

**A**: ä¿®æ”¹ `benchmark.c` ä¸­çš„ `get_time_ms()` å‡½æ•°ï¼Œä½¿ç”¨å¼€å‘æ¿æ”¯æŒçš„æ—¶é—´APIã€‚

### Q2: æ€§èƒ½æµ‹è¯•ç»“æœä¸ç¨³å®š

**A**: å¢åŠ æµ‹è¯•æ¬¡æ•° `NUM_RUNS`ï¼Œæˆ–å…³é—­å…¶ä»–è¿›ç¨‹å‡å°‘å¹²æ‰°ã€‚

### Q4: å†…å­˜ä¸è¶³

**A**: å¯ä»¥å‡å°‘æµ‹è¯•è§„æ¨¡ï¼Œä¿®æ”¹ `test_cases[]` æ•°ç»„ï¼Œåªä¿ç•™å°çŸ©é˜µæµ‹è¯•ã€‚

### Q5: æµ®ç‚¹è¿ç®—ä¸æ”¯æŒ

**A**: ç¡®ä¿å¼€å‘æ¿æ”¯æŒç¡¬ä»¶æµ®ç‚¹è¿ç®—ï¼Œæˆ–ç¼–è¯‘æ—¶æ·»åŠ è½¯æµ®ç‚¹é€‰é¡¹ã€‚

---

## ğŸ“Œ æµ‹è¯•ç»“æœè¯´æ˜

### æ§åˆ¶å°è¾“å‡º

æµ‹è¯•ä¼šè¾“å‡º4ä¸ªæ€§èƒ½æ±‡æ€»è¡¨ï¼Œæ¯ä¸ªæ•°å€¼èŒƒå›´ä¸€ä¸ªï¼š

```
æ•°å€¼èŒƒå›´: Range_0_1 [0e+000, 1e+000]
ä¼˜åŒ–ç‰ˆæœ¬              |  16x16  |  24x24  | ... | 256x256 | 256x248
----------------------+---------+---------+-----+---------+--------
dgemm_unroll          | 0.00086 | 0.00275 | ... | 3.55321 | 3.25648
dgemm_unroll_ass      | 0.00093 | 0.00364 | ... | 3.60221 | 3.15580

æ•°å€¼èŒƒå›´: Range_1_1e3 [1e+000, 1e+003]
...

æ‰€æœ‰æµ‹è¯•å®Œæˆï¼
æ€»æµ‹è¯•æ•°: 72 (4èŒƒå›´ Ã— 2å®ç° Ã— 9è§„æ¨¡)
```

- æ—¶é—´å•ä½ï¼šæ¯«ç§’ï¼ˆç²¾ç¡®åˆ°8ä½å°æ•°ï¼‰
- æ¯ä¸ªå€¼ï¼š500æ¬¡è¿è¡Œçš„ç®€å•å¹³å‡

---

## ğŸ” è°ƒè¯•å»ºè®®

### å¯ç”¨è¯¦ç»†è¾“å‡º

åœ¨ä»£ç ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼š
```c
#define DEBUG 1

#if DEBUG
    printf("Debug: å½“å‰æµ‹è¯• %s\n", test_name);
#endif
```

### éªŒè¯å•ä¸ªçŸ©é˜µ

å¯ä»¥æ·»åŠ å•ç‹¬çš„æµ‹è¯•å‡½æ•°éªŒè¯ç‰¹å®šè§„æ¨¡ï¼š
```c
void test_single_case(int m, int n, int p) {
    // æµ‹è¯•ä»£ç 
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°ç§»æ¤é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç¼–è¯‘å™¨ç‰ˆæœ¬å’Œé€‰é¡¹
2. å¼€å‘æ¿çš„libcç‰ˆæœ¬
3. æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ
4. æ—¶é—´å‡½æ•°ç²¾åº¦æ˜¯å¦è¶³å¤Ÿ

---

**ç¥æµ‹è¯•é¡ºåˆ©ï¼** ğŸ‰
