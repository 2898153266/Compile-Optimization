# DGEMM ä¼˜åŒ–çº§åˆ«æ€§èƒ½æµ‹è¯•å·¥å…·

é’ˆå¯¹ FT2000Q å¹³å°çš„ DGEMM å¤šä¼˜åŒ–çº§åˆ«æ€§èƒ½æµ‹è¯•

## âš ï¸ é‡è¦æ›´æ–°

**âœ… Makefileé€’å½’è°ƒç”¨é—®é¢˜å·²ä¿®å¤ï¼**

ä¹‹å‰çš„Makefileå­˜åœ¨ç›®æ ‡åç§°å†²çªï¼Œå¯¼è‡´æ— é™é€’å½’ï¼š
- é—®é¢˜ï¼š`benchmark_O0` æ—¢æ˜¯æ„å»ºç›®æ ‡åˆæ˜¯phonyç›®æ ‡
- ä¿®å¤ï¼šé‡å‘½åä¸º `build_O0`, `build_O1`, `build_O2`, `build_O3`
- ç°åœ¨å¯ä»¥æ­£å¸¸ç¼–è¯‘å’Œæµ‹è¯•äº†ï¼

## ğŸ“‹ æµ‹è¯•è¯´æ˜

### æµ‹è¯•å†…å®¹
- **3ä¸ªå‡½æ•°ç‰ˆæœ¬**: `dgemm_naive`, `dgemm_unroll`, `dgemm_neon`
- **3ä¸ªç¼–è¯‘ä¼˜åŒ–çº§åˆ«**: O0, O1, O2
- **9ä¸ªæµ‹è¯•ç”¨ä¾‹**: ä» 16x16 åˆ° 256x256 çš„ä¸åŒçŸ©é˜µè§„æ¨¡
- **50æ¬¡é‡å¤æµ‹è¯•**: æ¯ä¸ªç”¨ä¾‹è¿è¡Œ50æ¬¡å–å¹³å‡å€¼

### å¹³å°è¦æ±‚
- **CPU**: FT2000Q (ARMv8, Cortex-A72)
- **ç¼–è¯‘å™¨**: GCC (æ”¯æŒ ARM NEON)
- **ç³»ç»Ÿ**: Linux

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### âš¡ æ–¹æ³•1ï¼šå¿«é€Ÿæµ‹è¯•O1å’ŒO2ï¼ˆæœ€å¿«ï¼‰
```bash
# ä¸€é”®æµ‹è¯•O1å’ŒO2ä¼˜åŒ–çº§åˆ«å¯¹æ¯”ï¼ˆçº¦5-10åˆ†é’Ÿï¼‰
chmod +x quick_test.sh
./quick_test.sh
```

### ğŸ“Š æ–¹æ³•2ï¼šæµ‹è¯•æ‰€æœ‰ä¼˜åŒ–çº§åˆ«ï¼ˆæ¨èï¼‰
```bash
# ä¸€é”®æµ‹è¯• O0, O1, O2ï¼ˆçº¦15-20åˆ†é’Ÿï¼‰
make test_all

# æˆ–ä½¿ç”¨è„šæœ¬
chmod +x test_all_opt.sh
./test_all_opt.sh
```

### ğŸ”§ æ–¹æ³•3ï¼šå•ç‹¬ç¼–è¯‘å’Œæµ‹è¯•
```bash
# ç¼–è¯‘å•ä¸ªä¼˜åŒ–çº§åˆ«ï¼ˆä½¿ç”¨æ–°çš„build_å‘½ä»¤ï¼‰
make build_O0    # ç¼–è¯‘O0ç‰ˆæœ¬
make build_O1    # ç¼–è¯‘O1ç‰ˆæœ¬
make build_O2    # ç¼–è¯‘O2ç‰ˆæœ¬

# æˆ–è€…ä¸€æ¬¡ç¼–è¯‘æ‰€æœ‰
make all_opt

# è¿è¡Œæµ‹è¯•
./benchmark_O1
./benchmark_O2
```

### ğŸ“ æ–¹æ³•4ï¼šä¼ ç»Ÿæ–¹å¼ï¼ˆé€ä¸ªæµ‹è¯•ï¼‰
```bash
# æµ‹è¯• O1
make clean
make OPT_LEVEL=O1
./benchmark_O1

# æµ‹è¯• O2
make clean
make OPT_LEVEL=O2
./benchmark_O2
```

---

## ğŸ“– è¯¦ç»†ä½¿ç”¨

### 1. ç¼–è¯‘

#### ç¼–è¯‘é»˜è®¤ç‰ˆæœ¬ (O0)
```bash
make
```

#### ç¼–è¯‘æŒ‡å®šä¼˜åŒ–çº§åˆ«
```bash
make OPT_LEVEL=O0    # æ— ä¼˜åŒ–
make OPT_LEVEL=O1    # åŸºç¡€ä¼˜åŒ–
make OPT_LEVEL=O2    # é«˜çº§ä¼˜åŒ–
make OPT_LEVEL=O3    # æ¿€è¿›ä¼˜åŒ–
```

#### ç¼–è¯‘æ‰€æœ‰ä¼˜åŒ–çº§åˆ«
```bash
make all_opt         # ç¼–è¯‘ O0, O1, O2
```

### 2. è¿è¡Œæµ‹è¯•

#### è¿è¡Œå½“å‰ç¼–è¯‘çš„ç‰ˆæœ¬
```bash
make run
```

#### è¿è¡ŒæŒ‡å®šç‰ˆæœ¬
```bash
./benchmark_O0       # è¿è¡Œ O0 ç‰ˆæœ¬
./benchmark_O1       # è¿è¡Œ O1 ç‰ˆæœ¬
./benchmark_O2       # è¿è¡Œ O2 ç‰ˆæœ¬
```

#### ä¿å­˜ç»“æœåˆ°æ–‡ä»¶
```bash
./benchmark_O0 | tee my_results.txt
```

### 3. æ¸…ç†æ–‡ä»¶

```bash
make clean           # æ¸…ç†å½“å‰ç‰ˆæœ¬
make clean_all       # æ¸…ç†æ‰€æœ‰ä¼˜åŒ–çº§åˆ«
```

---

## ğŸ“Š è¾“å‡ºæ–‡ä»¶è¯´æ˜

### æµ‹è¯•è¿è¡Œåä¼šç”Ÿæˆï¼š

1. **å¯æ‰§è¡Œæ–‡ä»¶**
   - `benchmark_O0` - O0ä¼˜åŒ–çº§åˆ«çš„å¯æ‰§è¡Œæ–‡ä»¶
   - `benchmark_O1` - O1ä¼˜åŒ–çº§åˆ«çš„å¯æ‰§è¡Œæ–‡ä»¶
   - `benchmark_O2` - O2ä¼˜åŒ–çº§åˆ«çš„å¯æ‰§è¡Œæ–‡ä»¶

2. **ç»“æœæ–‡ä»¶**
   - `benchmark_results_O0.csv` - O0æ€§èƒ½æ•°æ®ï¼ˆCSVæ ¼å¼ï¼‰
   - `benchmark_results_O1.csv` - O1æ€§èƒ½æ•°æ®
   - `benchmark_results_O2.csv` - O2æ€§èƒ½æ•°æ®

3. **æ—¥å¿—æ–‡ä»¶**ï¼ˆå¦‚æœä½¿ç”¨ `tee`ï¼‰
   - `results_O0.txt` - O0å®Œæ•´æµ‹è¯•æ—¥å¿—
   - `results_O1.txt` - O1å®Œæ•´æµ‹è¯•æ—¥å¿—
   - `results_O2.txt` - O2å®Œæ•´æµ‹è¯•æ—¥å¿—

### CSVæ–‡ä»¶æ ¼å¼ç¤ºä¾‹
```
ä¼˜åŒ–ç‰ˆæœ¬,Small_PowerOfTwo_Square(16x16x16),Small_NonPowerOfTwo_Square(24x24x24),...
dgemm_naive,0.12,0.45,...
dgemm_unroll,0.08,0.32,...
dgemm_neon,0.05,0.18,...
```

---

## ğŸ”§ Makefile å‘½ä»¤å‚è€ƒ

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `make` | ç¼–è¯‘é»˜è®¤ç‰ˆæœ¬ (O0) |
| `make OPT_LEVEL=O1` | ç¼–è¯‘O1ç‰ˆæœ¬ |
| `make all_opt` | ç¼–è¯‘ O0, O1, O2 ä¸‰ä¸ªç‰ˆæœ¬ |
| `make test_all` | ç¼–è¯‘å¹¶è¿è¡Œæ‰€æœ‰ä¼˜åŒ–çº§åˆ«æµ‹è¯• |
| `make run` | è¿è¡Œå½“å‰ç‰ˆæœ¬ |
| `make clean` | æ¸…ç†å½“å‰ç‰ˆæœ¬æ–‡ä»¶ |
| `make clean_all` | æ¸…ç†æ‰€æœ‰ä¼˜åŒ–çº§åˆ«æ–‡ä»¶ |
| `make info` | æ˜¾ç¤ºç¼–è¯‘é…ç½®ä¿¡æ¯ |
| `make help` | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ |

---

## ğŸ“ˆ ç»“æœåˆ†æ

### æŸ¥çœ‹å•ä¸ªä¼˜åŒ–çº§åˆ«ç»“æœ
```bash
cat benchmark_results_O0.csv
```

### å¯¹æ¯”ä¸åŒä¼˜åŒ–çº§åˆ«
```bash
# ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·å¯¹æ¯”
echo "=== O0 ==="
cat benchmark_results_O0.csv
echo "=== O1 ==="
cat benchmark_results_O1.csv
echo "=== O2 ==="
cat benchmark_results_O2.csv
```

### ä¸‹è½½åˆ°æœ¬åœ°åˆ†æ
```bash
# åœ¨æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œ
scp user@ft2000q:/path/to/ft2000q_new_test/benchmark_results_*.csv ./
```

ç„¶åä½¿ç”¨Excelæˆ–å…¶ä»–å·¥å…·æ‰“å¼€CSVæ–‡ä»¶è¿›è¡Œåˆ†æã€‚

---

## âš™ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹æµ‹è¯•å‚æ•°

ç¼–è¾‘ `benchmark.c` ä¸­çš„é…ç½®ï¼š

```c
#define NUM_RUNS 50           // æ¯ä¸ªæµ‹è¯•è¿è¡Œæ¬¡æ•°
#define TEST_MODE 0           // 0=op-lybæ¨¡å¼, 1=çƒ­ç¼“å­˜, 2=å®Œæ•´æµç¨‹
#define VERIFY_CORRECTNESS 0  // æ˜¯å¦éªŒè¯æ­£ç¡®æ€§
```

### ä¿®æ”¹ç¼–è¯‘é€‰é¡¹

ç¼–è¾‘ `Makefile`ï¼š

```makefile
CFLAGS = -$(OPT_LEVEL) -Wall -march=armv8-a -mtune=cortex-a72 -fopenmp
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### ç¼–è¯‘é”™è¯¯

**é—®é¢˜**: `undefined reference to 'clock_gettime'`
```bash
# è§£å†³: ç¡®ä¿é“¾æ¥äº† -lrt
make clean
make
```

**é—®é¢˜**: NEON æŒ‡ä»¤ä¸æ”¯æŒ
```bash
# æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦æ”¯æŒ NEON
gcc -march=armv8-a -Q --help=target | grep neon
```

### è¿è¡Œé”™è¯¯

**é—®é¢˜**: æƒé™ä¸è¶³
```bash
chmod +x benchmark_O0
chmod +x benchmark_O1
chmod +x benchmark_O2
chmod +x test_all_opt.sh
```

**é—®é¢˜**: å†…å­˜åˆ†é…å¤±è´¥
```bash
# æ£€æŸ¥å¯ç”¨å†…å­˜
free -h
# å¯¹äºå¤§çŸ©é˜µæµ‹è¯•ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿå†…å­˜
```

---

## ğŸ“ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### O0 vs O1 vs O2

- **O0**: æ— ä¼˜åŒ–ï¼Œç¼–è¯‘æœ€å¿«ï¼Œæ€§èƒ½æœ€ä½ï¼Œç”¨äºè°ƒè¯•
- **O1**: åŸºç¡€ä¼˜åŒ–ï¼Œç¼–è¯‘è¾ƒå¿«ï¼Œæ€§èƒ½ä¸­ç­‰
- **O2**: é«˜çº§ä¼˜åŒ–ï¼Œç¼–è¯‘è¾ƒæ…¢ï¼Œæ€§èƒ½æœ€ä½³ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
- **O3**: æ¿€è¿›ä¼˜åŒ–ï¼Œå¯èƒ½å¯¼è‡´ä»£ç ä½“ç§¯å¢å¤§

### é¢„æœŸæ€§èƒ½æå‡

åŸºäºå…¸å‹åœºæ™¯ï¼š
- O1 ç›¸å¯¹ O0: 1.5x - 3x åŠ é€Ÿ
- O2 ç›¸å¯¹ O0: 2x - 5x åŠ é€Ÿ
- NEON ç›¸å¯¹ naive: 3x - 10x åŠ é€Ÿï¼ˆå¤§çŸ©é˜µï¼‰

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç¼–è¯‘å™¨ç‰ˆæœ¬: `gcc --version`
2. CPUä¿¡æ¯: `lscpu`
3. ç¼–è¯‘é€‰é¡¹: `make info`

---

## ğŸ¯ å¿«é€Ÿæµ‹è¯•æµç¨‹

```bash
# å®Œæ•´æµ‹è¯•æµç¨‹ï¼ˆçº¦éœ€è¦å‡ åˆ†é’Ÿï¼‰
cd ft2000q_new_test
make help              # æŸ¥çœ‹å¸®åŠ©
make info              # æŸ¥çœ‹é…ç½®
make test_all          # è¿è¡Œæ‰€æœ‰æµ‹è¯•
ls -lh *.csv           # æŸ¥çœ‹ç»“æœæ–‡ä»¶
cat benchmark_results_O2.csv  # æŸ¥çœ‹O2ç»“æœ
```

å®Œæˆï¼ğŸ‰
