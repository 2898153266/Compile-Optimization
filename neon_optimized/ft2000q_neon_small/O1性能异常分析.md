# O1ä¼˜åŒ–çº§åˆ«æ€§èƒ½å¼‚å¸¸åˆ†ææŠ¥å‘Š

## ğŸš¨ é—®é¢˜ç°è±¡

**dgemm_naiveåœ¨O1ä¼˜åŒ–çº§åˆ«ä¸‹æ¯”O0æ…¢3-5å€ï¼**

### æ€§èƒ½å¯¹æ¯”æ•°æ®

| æµ‹è¯•ç”¨ä¾‹ | O0 (ms) | O1 (ms) | æ€§èƒ½å˜åŒ– |
|---------|---------|---------|----------|
| 16Ã—16 | 0.051 | 0.151 | **æ…¢3.0å€** âŒ |
| 24Ã—24 | 0.135 | 0.449 | **æ…¢3.3å€** âŒ |
| 24Ã—32Ã—16 | 0.072 | 0.406 | **æ…¢5.6å€** âŒ |
| 96Ã—96 | 5.113 | 28.281 | **æ…¢5.5å€** âŒ |
| 128Ã—128 | 12.025 | 66.845 | **æ…¢5.5å€** âŒ |
| 120Ã—128Ã—96 | 8.516 | 47.179 | **æ…¢5.5å€** âŒ |
| 240Ã—240 | 251.101 | 446.044 | **æ…¢1.8å€** âŒ |
| 256Ã—256 | 531.313 | 541.001 | æ…¢1.0å€ |
| 256Ã—240Ã—248 | 406.637 | 491.628 | **æ…¢1.2å€** âŒ |

**å…³é”®å‘ç°**ï¼š
- âœ… dgemm_unroll å’Œ dgemm_neon åœ¨O1ä¸‹æ€§èƒ½æ­£å¸¸
- âŒ **åªæœ‰ dgemm_naive** å‡ºç°ä¸¥é‡æ€§èƒ½é€€åŒ–
- ğŸ” å°çŸ©é˜µ(16-128)é€€åŒ–æœ€ä¸¥é‡(3-5.6å€)
- ğŸ” å¤§çŸ©é˜µ(256)é€€åŒ–è¾ƒè½»(1-2å€)

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### å½“å‰ dgemm_naive å®ç°

```c
#define A(i, j) a[(i) * lda + j]
#define B(i, j) b[(i) * ldb + j]
#define C(i, j) c[(i) * ldc + j]

void dgemm_naive(unsigned int m, unsigned int n, unsigned int p, 
                 double *a, unsigned int lda,
                 double *b, unsigned int ldb,
                 double *c, unsigned int ldc)
{
    register unsigned int i, j, k;
    register double tmp;    

    for(i = 0; i < m; ++i)
    {
        for(k = 0; k < p; ++k)
        {
            tmp = A(i, k);
            for(j = 0; j < n; ++j)
            {
                C(i, j) += tmp * B(k, j);  // âš ï¸ é—®é¢˜ç‚¹
            }            
        }
    }
}
```

### é—®é¢˜1ï¼š`register` å…³é”®å­—å¹²æ‰°ç¼–è¯‘å™¨ä¼˜åŒ–

**O0çº§åˆ«**ï¼š
- ç¼–è¯‘å™¨å¿½ç•¥ `register` æç¤º
- ç”Ÿæˆç®€å•ç›´æ¥çš„ä»£ç 
- æ­£å¸¸çš„å†…å­˜è®¿é—®æ¨¡å¼

**O1çº§åˆ«**ï¼š
- ç¼–è¯‘å™¨è¯•å›¾éµå®ˆ `register` æç¤ºï¼Œä½†å¯èƒ½äº§ç”Ÿå†²çª
- å¼ºåˆ¶æŸäº›å˜é‡æ”¾å…¥å¯„å­˜å™¨å¯èƒ½é˜»æ­¢æ›´å¥½çš„ä¼˜åŒ–
- ç°ä»£ç¼–è¯‘å™¨æ¯”ç¨‹åºå‘˜æ›´äº†è§£å¯„å­˜å™¨åˆ†é…

### é—®é¢˜2ï¼šå®å±•å¼€å¯èƒ½å¯¼è‡´åˆ«ååˆ†æå¤±è´¥

O1ä¼˜åŒ–ä¼šè¿›è¡Œåˆ«ååˆ†æï¼ˆalias analysisï¼‰ï¼Œä½†å®å®šä¹‰ `A(i,j)` å¯èƒ½è®©ç¼–è¯‘å™¨æ— æ³•ç¡®å®šï¼š
- `C(i, j)` å’Œ `B(k, j)` æ˜¯å¦æœ‰å†…å­˜é‡å 
- å¯¼è‡´ç¼–è¯‘å™¨æ’å…¥ä¸å¿…è¦çš„å†…å­˜åŒæ­¥
- æ¯æ¬¡å¾ªç¯éƒ½è¦é‡æ–°åŠ è½½ `C(i, j)`

### é—®é¢˜3ï¼šç´¯åŠ æ“ä½œæœªä¼˜åŒ–

```c
C(i, j) += tmp * B(k, j);
```

åœ¨O1ä¸‹å¯èƒ½è¢«ç¿»è¯‘ä¸ºï¼š
1. ä»å†…å­˜è¯»å– C(i,j) 
2. è®¡ç®— tmp * B(k,j)
3. åŠ æ³•
4. å†™å›å†…å­˜ C(i,j)

**æ¯æ¬¡å¾ªç¯éƒ½è¦åšä¸€æ¬¡å†…å­˜è¯»å†™**ï¼Œè€ŒO0å¯èƒ½åœ¨å¯„å­˜å™¨ä¸­æš‚å­˜ã€‚

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç§»é™¤ `register` å…³é”®å­—ï¼ˆæ¨èï¼‰âœ…

```c
void dgemm_naive(unsigned int m, unsigned int n, unsigned int p, 
                 double *a, unsigned int lda,
                 double *b, unsigned int ldb,
                 double *c, unsigned int ldc)
{
    unsigned int i, j, k;  // ç§»é™¤register
    double tmp;            // ç§»é™¤register

    for(i = 0; i < m; ++i) {
        for(k = 0; k < p; ++k) {
            tmp = A(i, k);
            for(j = 0; j < n; ++j) {
                C(i, j) += tmp * B(k, j);
            }            
        }
    }
}
```

**ä¼˜ç‚¹**ï¼šç®€å•ï¼Œè®©ç¼–è¯‘å™¨è‡ªä¸»å†³å®šä¼˜åŒ–ç­–ç•¥

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ `restrict` æŒ‡é’ˆä¼˜åŒ–ï¼ˆæ¨èï¼‰âœ…

```c
void dgemm_naive(unsigned int m, unsigned int n, unsigned int p, 
                 double * restrict a, unsigned int lda,
                 double * restrict b, unsigned int ldb,
                 double * restrict c, unsigned int ldc)
{
    unsigned int i, j, k;

    for(i = 0; i < m; ++i) {
        for(k = 0; k < p; ++k) {
            double tmp = A(i, k);
            for(j = 0; j < n; ++j) {
                C(i, j) += tmp * B(k, j);
            }            
        }
    }
}
```

**ä¼˜ç‚¹**ï¼šå‘Šè¯‰ç¼–è¯‘å™¨æŒ‡é’ˆä¸é‡å ï¼Œå…è®¸æ›´æ¿€è¿›çš„ä¼˜åŒ–

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨å±€éƒ¨ç´¯åŠ å™¨ï¼ˆæœ€ä¼˜ï¼‰â­

```c
void dgemm_naive(unsigned int m, unsigned int n, unsigned int p, 
                 double * restrict a, unsigned int lda,
                 double * restrict b, unsigned int ldb,
                 double * restrict c, unsigned int ldc)
{
    for(unsigned int i = 0; i < m; ++i) {
        for(unsigned int j = 0; j < n; ++j) {
            double sum = c[i * ldc + j];  // è¯»å–ä¸€æ¬¡
            for(unsigned int k = 0; k < p; ++k) {
                sum += a[i * lda + k] * b[k * ldb + j];
            }
            c[i * ldc + j] = sum;  // å†™å›ä¸€æ¬¡
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- å½»åº•é¿å…åˆ«åé—®é¢˜
- C(i,j)åªè¯»å†™å„ä¸€æ¬¡
- å†…å±‚å¾ªç¯çš„ `sum` å¯ä»¥å¸¸é©»å¯„å­˜å™¨

### æ–¹æ¡ˆ4ï¼šæ·»åŠ ä¼˜åŒ–æç¤ºæ³¨é‡Š

```c
void dgemm_naive(unsigned int m, unsigned int n, unsigned int p, 
                 double * restrict a, unsigned int lda,
                 double * restrict b, unsigned int ldb,
                 double * restrict c, unsigned int ldc)
{
    unsigned int i, j, k;

    for(i = 0; i < m; ++i) {
        for(k = 0; k < p; ++k) {
            double tmp = A(i, k);
            #pragma GCC ivdep  // å‘Šè¯‰GCCå¾ªç¯æ²¡æœ‰ä¾èµ–
            for(j = 0; j < n; ++j) {
                C(i, j) += tmp * B(k, j);
            }            
        }
    }
}
```

---

## ğŸ§ª éªŒè¯æ–¹æ¡ˆ

### å»ºè®®æµ‹è¯•é¡ºåº

1. **å¿«é€Ÿæµ‹è¯•**ï¼ˆåªä¿®æ”¹dgemm_naive.cï¼‰

```bash
# å¤‡ä»½åŸæ–‡ä»¶
cp dgemm_naive.c dgemm_naive.c.backup

# åº”ç”¨æ–¹æ¡ˆ1ï¼ˆç§»é™¤registerï¼‰
vi dgemm_naive.c  # ç¼–è¾‘

# é‡æ–°ç¼–è¯‘æµ‹è¯•
make clean
make build_O1
./benchmark_O1

# å¯¹æ¯”æ€§èƒ½
```

2. **å®Œæ•´å¯¹æ¯”æµ‹è¯•**

åˆ›å»ºå¤šä¸ªç‰ˆæœ¬ï¼š
- `dgemm_naive_v1.c` - ç§»é™¤register
- `dgemm_naive_v2.c` - ä½¿ç”¨restrict
- `dgemm_naive_v3.c` - å±€éƒ¨ç´¯åŠ å™¨

åˆ†åˆ«æµ‹è¯•æ€§èƒ½ã€‚

---

## ğŸ“Š é¢„æœŸç»“æœ

### æ–¹æ¡ˆ1ï¼ˆç§»é™¤registerï¼‰

é¢„è®¡O1æ€§èƒ½æ¢å¤åˆ°ä¸O0ç›¸å½“æˆ–æ›´å¥½ï¼š
- 16Ã—16: 0.051ms (O0) â†’ ~0.03-0.04ms (O1ä¿®å¤)
- 128Ã—128: 12.025ms (O0) â†’ ~8-10ms (O1ä¿®å¤)

### æ–¹æ¡ˆ2ï¼ˆrestrictï¼‰

é¢„è®¡O1æ€§èƒ½æå‡10-20%ï¼š
- ç¼–è¯‘å™¨å¯ä»¥åšæ›´æ¿€è¿›çš„ä¼˜åŒ–
- é¿å…ä¸å¿…è¦çš„å†…å­˜é‡å¤è¯»å–

### æ–¹æ¡ˆ3ï¼ˆå±€éƒ¨ç´¯åŠ å™¨ï¼‰

é¢„è®¡O1æ€§èƒ½æå‡30-50%ï¼š
- æœ€ä¼˜çš„å†…å­˜è®¿é—®æ¨¡å¼
- æœ€å°‘çš„å†…å­˜è¯»å†™æ¬¡æ•°

---

## ğŸ¯ æ¨èè¡ŒåŠ¨æ–¹æ¡ˆ

### ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# 1. ç¼–è¾‘ dgemm_naive.c
vi dgemm_naive.c

# 2. ç§»é™¤ç¬¬15-16è¡Œçš„ register å…³é”®å­—
#    ä¿®æ”¹å‰: register unsigned int i, j, k;
#    ä¿®æ”¹å: unsigned int i, j, k;
#    
#    ä¿®æ”¹å‰: register double tmp;
#    ä¿®æ”¹å: double tmp;

# 3. ä¿å­˜å¹¶é‡æ–°æµ‹è¯•
make clean
make build_O1
./benchmark_O1 | tee results_O1_fixed.txt

# 4. å¯¹æ¯”ç»“æœ
diff results_O1.txt results_O1_fixed.txt
```

### æ·±å…¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼Œ30åˆ†é’Ÿï¼‰

å¦‚æœæ—¶é—´å…è®¸ï¼Œå»ºè®®å®æ–½**æ–¹æ¡ˆ3ï¼ˆå±€éƒ¨ç´¯åŠ å™¨ï¼‰**ï¼š
- æ€§èƒ½æœ€ä¼˜
- ä»£ç ä¾ç„¶ç®€æ´
- é€‚åˆæ‰€æœ‰ä¼˜åŒ–çº§åˆ«

---

## ğŸ“– æŠ€æœ¯èƒŒæ™¯

### `register` å…³é”®å­—çš„å†å²

**C89æ—¶ä»£**ï¼š
- ç¨‹åºå‘˜æç¤ºç¼–è¯‘å™¨å°†å˜é‡æ”¾å…¥å¯„å­˜å™¨
- æ—©æœŸç¼–è¯‘å™¨çš„å¯„å­˜å™¨åˆ†é…è¾ƒå¼±

**ç°ä»£ï¼ˆC11+ï¼‰**ï¼š
- ç¼–è¯‘å™¨çš„å¯„å­˜å™¨åˆ†é…ç®—æ³•è¿œè¶…äººç±»
- `register` å…³é”®å­—åŸºæœ¬è¢«åºŸå¼ƒ
- **GCCæ–‡æ¡£æ˜ç¡®è¯´æ˜**ï¼šO1åŠä»¥ä¸Šä¼šè‡ªåŠ¨è¿›è¡Œå¯„å­˜å™¨åˆ†é…ï¼Œæ‰‹åŠ¨æŒ‡å®šå¯èƒ½é€‚å¾—å…¶å

### GCCä¼˜åŒ–çº§åˆ«çš„å·®å¼‚

| çº§åˆ« | å¯„å­˜å™¨åˆ†é… | åˆ«ååˆ†æ | å¾ªç¯ä¼˜åŒ– |
|------|-----------|---------|---------|
| O0 | åŸºç¡€ | æ—  | æ—  |
| O1 | **å…¨å±€** | **å¯ç”¨** | åŸºç¡€ |
| O2 | å…¨å±€+é«˜çº§ | å¢å¼º | å±•å¼€+å‘é‡åŒ– |

O1çš„å…¨å±€å¯„å­˜å™¨åˆ†é…å’Œåˆ«ååˆ†æå¯èƒ½ä¸æ‰‹åŠ¨ `register` å†²çªï¼

---

## âœ… æ€»ç»“

1. **é—®é¢˜æ ¹æº**ï¼š`register` å…³é”®å­—å¹²æ‰°äº†O1çš„ä¼˜åŒ–
2. **å¿«é€Ÿä¿®å¤**ï¼šç§»é™¤ `register` å…³é”®å­—ï¼ˆ5åˆ†é’Ÿï¼‰
3. **æœ€ä¼˜æ–¹æ¡ˆ**ï¼šé‡å†™ä¸ºå±€éƒ¨ç´¯åŠ å™¨æ¨¡å¼ï¼ˆ30åˆ†é’Ÿï¼‰
4. **é¢„æœŸæ•ˆæœ**ï¼šO1æ€§èƒ½åº”æ¯”O0å¿«20-40%

**å»ºè®®**ï¼šå…ˆåº”ç”¨å¿«é€Ÿä¿®å¤éªŒè¯é—®é¢˜ï¼Œç¡®è®¤åå†è€ƒè™‘æ·±åº¦ä¼˜åŒ–ã€‚

